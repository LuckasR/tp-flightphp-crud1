<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Validation d‚Äôun Pr√™t</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 15px; }
    section { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 6px; margin-top: 3px; }
    button { margin-top: 10px; padding: 8px 15px; }
  </style>
</head>
<body>

<h1>Validation d‚Äôun Pr√™t</h1>

<section>
  <input type="hidden" id="pret_id">

  <label>Admin validateur</label>
  <select id="id_admin_validateur"></select>

  <label>Montant accord√©</label>
  <input type="number" id="montant_accorde">

  <label>Dur√©e accord√©e (mois)</label>
  <input type="number" id="duree_accordee">

  <label>Taux appliqu√© (%)</label>
  <input type="number" step="0.01" id="taux_applique">

  <label>Frais de dossier</label>
  <input type="number" id="frais_dossier">

  <label>Frais d'assurance</label>
  <input type="number" id="frais_assurance">

  <button onclick="confirmerValidation()">Confirmer la validation</button>
</section>

<script>
const api = "http://localhost/tp-flightphp-crud1/ws";

// üß† R√©cup√©rer l‚ÄôID du pr√™t depuis l‚ÄôURL
const pretId = window.location.pathname.split('/').pop();
document.getElementById("pret_id").value = pretId;

// ‚úÖ Requ√™te Ajax
function ajax(method, url, data, callback) {
  const xhr = new XMLHttpRequest();
  xhr.open(method, api + url, true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
      if (xhr.status === 200 && callback) callback(JSON.parse(xhr.responseText));
      else if (xhr.readyState === 4) alert("Erreur : " + xhr.responseText);
    }
  };
  xhr.send(data);
}

// üîÑ Remplir le select des admins
function remplirSelect(id, endpoint, label = 'nom') {
  ajax("GET", "/" + endpoint, null, data => {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">-- Choisir --</option>`;
    data.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e[label];
      select.appendChild(opt);
    });
  });
}

// ‚úÖ Valider le pr√™t
function confirmerValidation() {
  const id = document.getElementById("pret_id").value;
  const data = 
    "id_admin_validateur=" + id_admin_validateur.value +
    "&montant_accorde=" + montant_accorde.value +
    "&duree_accordee=" + duree_accordee.value +
    "&taux_applique=" + taux_applique.value +
    "&frais_dossier=" + frais_dossier.value +
    "&frais_assurance=" + frais_assurance.value;

  ajax("PUT", `/prets/valider/${id}`, data, () => {
    alert("Pr√™t valid√© avec succ√®s !");
    window.location.href = "/tp-flightphp-crud1/ws/"; // redirection apr√®s validation
  });
}

// Initialisation
remplirSelect("id_admin_validateur", "admins");
</script>

</body>
</html>
