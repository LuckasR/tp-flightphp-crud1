<?php include('template_header.php'); ?>
<h1 class="text-center my-4 text-primary">Validation d‚Äôun Pr√™t</h1>

<div class="container">
  <form class="row g-3">
    <input type="hidden" id="pret_id">

    <div class="col-md-6">
      <label for="id_admin_validateur" class="form-label">Admin validateur</label>
      <select id="id_admin_validateur" class="form-select"></select>
    </div>

    <div class="col-md-6">
      <label for="montant_accorde" class="form-label">Montant accord√©</label>
      <input type="number" id="montant_accorde" class="form-control" placeholder="Montant accord√©">
    </div>

    <div class="col-md-6">
      <label for="duree_accordee" class="form-label">Dur√©e accord√©e (mois)</label>
      <input type="number" id="duree_accordee" class="form-control" placeholder="Dur√©e en mois">
    </div>

    <div class="col-md-6">
      <label for="taux_applique" class="form-label">Taux appliqu√© (%)</label>
      <input type="number" step="0.01" id="taux_applique" class="form-control" placeholder="Taux appliqu√©">
    </div>

    <div class="col-md-6">
      <label for="frais_dossier" class="form-label">Frais de dossier</label>
      <input type="number" id="frais_dossier" class="form-control" placeholder="Frais de dossier">
    </div>

    <div class="col-md-6">
      <label for="frais_assurance" class="form-label">Frais d'assurance</label>
      <input type="number" id="frais_assurance" class="form-control" placeholder="Frais d'assurance">
    </div>

    <div class="col-12 text-end">
      <button type="button" onclick="confirmerValidation()" class="btn btn-success">
        Confirmer la validation
      </button>
    </div>
  </form>
</div>


<script>
const api = "http://localhost/tp-flightphp-crud1/ws";

// üß† R√©cup√©rer l‚ÄôID du pr√™t depuis l‚ÄôURL
const pretId = window.location.pathname.split('/').pop();
document.getElementById("pret_id").value = pretId;

// ‚úÖ Requ√™te Ajax
function ajax(method, url, data, callback) {
  const xhr = new XMLHttpRequest();
  xhr.open(method, api + url, true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
      if (xhr.status === 200 && callback) callback(JSON.parse(xhr.responseText));
      else if (xhr.readyState === 4) alert("Erreur : " + xhr.responseText);
    }
  };
  xhr.send(data);
}

// üîÑ Remplir le select des admins
function remplirSelect(id, endpoint, label = 'nom') {
  ajax("GET", "/" + endpoint, null, data => {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">-- Choisir --</option>`;
    data.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e[label];
      select.appendChild(opt);
    });
  });
}

// ‚úÖ Valider le pr√™t
function confirmerValidation() {
  const id = document.getElementById("pret_id").value;
  const data = 
    "id_admin_validateur=" + id_admin_validateur.value +
    "&montant_accorde=" + montant_accorde.value +
    "&duree_accordee=" + duree_accordee.value +
    "&taux_applique=" + taux_applique.value +
    "&frais_dossier=" + frais_dossier.value +
    "&frais_assurance=" + frais_assurance.value;

  ajax("PUT", `/prets/valider/${id}`, data, () => {
    alert("Pr√™t valid√© avec succ√®s !");
    window.location.href = "/tp-flightphp-crud1/ws/"; // redirection apr√®s validation
  });
}

// Initialisation
remplirSelect("id_admin_validateur", "admins");
</script>
 

<?php include('template_footer.php'); ?>
