<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport des Intérêts Mensuels</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .form-group { margin-bottom: 15px; }
        canvas { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Rapport des Intérêts Mensuels</h1>
    <div class="form-group">
        <label>Année Début:</label>
        <input type="number" id="annee_debut" value="2025" min="2000" max="2030">
        <label>Mois Début:</label>
        <select id="mois_debut">
            <option value="1">Janvier</option>
            <option value="2">Février</option>
            <option value="3">Mars</option>
            <option value="4">Avril</option>
            <option value="5">Mai</option>
            <option value="6">Juin</option>
            <option value="7">Juillet</option>
            <option value="8">Août</option>
            <option value="9">Septembre</option>
            <option value="10">Octobre</option>
            <option value="11">Novembre</option>
            <option value="12">Décembre</option>
        </select>
    </div>
    <div class="form-group">
        <label>Année Fin:</label>
        <input type="number" id="annee_fin" value="2025" min="2000" max="2030">
        <label>Mois Fin:</label>
        <select id="mois_fin">
            <option value="1">Janvier</option>
            <option value="2">Février</option>
            <option value="3">Mars</option>
            <option value="4">Avril</option>
            <option value="5">Mai</option>
            <option value="6">Juin</option>
            <option value="7">Juillet</option>
            <option value="8">Août</option>
            <option value="9">Septembre</option>
            <option value="10">Octobre</option>
            <option value="11">Novembre</option>
            <option value="12">Décembre</option>
        </select>
    </div>
    <button onclick="fetchInterestData()">Afficher</button>
    <table id="interestTable">
        <thead>
            <tr>
                <th>Année</th>
                <th>Mois</th>
                <th>Mois et Année</th>
                <th>Intérêts Mensuels (€)</th>
            </tr>
        </thead>
        <tbody id="interestTableBody"></tbody>
    </table>
    <canvas id="interestChart" width="400" height="200"></canvas>

  <script>
        // Définir apiBase comme dans l'autre fichier
        const apiBase = "http://localhost/tp-flightphp-crud1/ws";
        let chartInstance = null;

        async function fetchInterestData() {
            const annee_debut = document.getElementById('annee_debut').value;
            const mois_debut = document.getElementById('mois_debut').value;
            const annee_fin = document.getElementById('annee_fin').value;
            const mois_fin = document.getElementById('mois_fin').value;

            console.log('Envoi des données:', { annee_debut, mois_debut, annee_fin, mois_fin });

            try {
                // Utiliser apiBase dans l'URL
                const response = await axios.post(`${apiBase}/etablissements/monthly_interest`, {
                    annee_debut: parseInt(annee_debut),
                    mois_debut: parseInt(mois_debut),
                    annee_fin: parseInt(annee_fin),
                    mois_fin: parseInt(mois_fin)
                }, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Réponse reçue:', response.data);
                const data = response.data;

                // Update table
                const tableBody = document.getElementById('interestTableBody');
                tableBody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.annee}</td>
                        <td>${row.mois}</td>
                        <td>${row.mois_annee}</td>
                        <td>${row.interet_mensuel}</td>
                    `;
                    tableBody.appendChild(tr);
                });

                // Update chart
                const ctx = document.getElementById('interestChart').getContext('2d');
                if (chartInstance) {
                    chartInstance.destroy();
                }
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(row => row.mois_annee),
                        datasets: [{
                            label: 'Intérêts Mensuels (€)',
                            data: data.map(row => row.interet_mensuel),
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: { display: true, text: 'Mois et Année' }
                            },
                            y: {
                                title: { display: true, text: 'Intérêts (€)' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
        console.error('Erreur détaillée:', error.response?.data || error.message);
        alert('Erreur lors de la récupération des données: ' + (error.response?.data?.error || error.message));
    }
        }
    </script>
</body>
</html>